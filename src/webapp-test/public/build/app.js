function e$1(e){return Array.isArray(e)&&"subscribe"in e&&"function"==typeof e.subscribe}function t$1(e,t){if(e&&0!=e.length)for(let n=e.length-1;n>=0;n--)t(e[n]);}function n$1(t){if(e$1(t))return;let n;const i=t;return i.raise=e=>{n&&n.forEach((t=>e(t)));},i.subscribe=function(e){n||(n=[]);return -1==n.indexOf(e)&&n.push(e),e},i.unsubscribe=function(e){if(!n)return;const t=n.indexOf(e);-1!=t&&n.splice(t,1);},t.reverse=function(){const e=Array.prototype.reverse.call(this);return this.raise((e=>e.onReorder&&e.onReorder())),e},t.sort=function(...e){const t=Array.prototype.sort.call(this,...e);return this.raise((e=>e.onReorder&&e.onReorder())),t},t.push=function(...e){const t=this.length,n=Array.prototype.push.call(this,...e);for(let e=t;e<this.length;e++)this.raise((t=>t.onItemAdded&&t.onItemAdded(this[e],e,"add")));return this.raise((e=>e.onChanged&&e.onChanged())),n},t.shift=function(){const e=Array.prototype.shift.call(this);return void 0!==e&&(this.raise((t=>t.onItemRemoved&&t.onItemRemoved(e,0,"remove"))),this.raise((e=>e.onChanged&&e.onChanged()))),e},t.pop=function(){const e=Array.prototype.pop.call(this);return void 0!==e&&(this.raise((t=>t.onItemRemoved&&t.onItemRemoved(e,this.length,"remove"))),this.raise((e=>e.onChanged&&e.onChanged()))),e},t.splice=function(e,t,...n){const i=Array.prototype.splice.call(this,e,t,...n);if(0==e&&t>=this.length&&(!n||0==n.length)&&this.raise((e=>e.onClear&&e.onClear())),t>0)for(let n=0;n<t;n++)this.raise((t=>t.onItemRemoved&&t.onItemRemoved(i[n],n+e,"remove")));if(n.length>0)for(let t=0;t<n.length;t++)this.raise((i=>i.onItemAdded&&i.onItemAdded(n[t],t+e,"insert")));return this.raise((e=>e.onChanged&&e.onChanged())),i},i}const i$1=Symbol("Props");function s(e){if(!e)return;let t=e["@typeName"];if(!t){if(t=typeof e,"function"==t)return function(e){let t=e.name;if(!t){const n=/function\s([^(]{1,})\(/.exec(e.toString());t=n&&n.length>1?n[1].trim():"";}return t}(e);if("object"==t){const t=e.constructor;if(t)return s(t)}}return t}class r{_handlers;_descriptor;constructor(e,t){this._descriptor=e,this.name=t;}get(){return this._descriptor.get?this._descriptor.get():this._descriptor.value}set(e){const n=this.get();this._descriptor.set?this._descriptor.set(e):this._descriptor.value=e,n!==e&&this._handlers&&t$1(this._handlers,(t=>t(e,n)));}notifyChanged(){const e=this.get();t$1(this._handlers,(t=>t(e,void 0)));}subscribe(e){this._handlers||(this._handlers=[]);return -1==this._handlers.indexOf(e)&&this._handlers.push(e),e}unsubscribe(e){if(!this._handlers)return;const t=this._handlers.indexOf(e);-1!=t&&this._handlers.splice(t,1);}name}function o(e,t,n,i){const s=l(e,t);if(s)return s;const r=a(e,t,n);return void 0!==i&&void 0===r.get()&&r.set(i),r}function l(e,t){if(i$1 in e)return e[i$1][t]}function a(e,t,n){let o=Object.getOwnPropertyDescriptor(e,t);return o||(console.warn("'",t,"' not defined in ",s(e)),o={}),n||(n=new r(o,t)),i$1 in e||Object.defineProperty(e,i$1,{value:{},enumerable:!1,writable:!1}),e[i$1][t]=n,Object.defineProperty(e,t,{get:()=>n.get(),set:e=>n.set(e)}),n}const h=Symbol("isProxy");class d{_bindings=[];_modelBinders=[];constructor(e){this.updateModel(e);}register(e){this._modelBinders.push(e);}getBindValue(e){return "function"==typeof e?e(this.model):e}getBindingValue(e,t=!0){return e.value(this.createProxy(this.model,((n,i)=>(t&&this.subscribe(n,i,e),!0))))}bind(e,t){if("function"==typeof e){const n={value:e,action:t,subscriptions:[],lastValue:void 0,suspend:0};this._bindings.push(n);const i=this.getBindingValue(n);n.action(i,void 0,!1),n.lastValue=i;}else t(e,void 0,!1);}unsubscribe(t,n){t.subscriptions.forEach((t=>{e$1(t.source)&&t.source.unsubscribe(t.handler),t.property&&t.property.unsubscribe(t.handler);})),n&&t.lastValue&&(t.action(null,t.lastValue,!0,!0),t.lastValue=null),t.subscriptions=[];}subscribe(t,n,i){for(let e=0;e<i.subscriptions.length;e++){const s=i.subscriptions[e];if(s.source==t&&s.name==n)return}if(e$1(t)){const e={onChanged:()=>{const e=this.getBindingValue(i);e!=i.lastValue&&(i.action(e,i.lastValue,!0),i.lastValue=e);}};t.subscribe(e);}const s=Object.getOwnPropertyDescriptor(t,n);if(!s&&Array.isArray(t)||!s.writable&&!s.set)return void console.warn("Property ",n," for object ",t," not exists or is not writeable.");const r=o(t,n),l=(s,r)=>{if(!(i.suspend>0)){i.suspend++;try{const o=this.getBindingValue(i,!1);if(o==i.lastValue)return;this.unsubscribe(i,!1),this.getBindingValue(i),i.action(o,i.lastValue,!0),e$1(t)&&(t.raise((e=>e.onChanged&&e.onChanged())),t.raise((e=>e.onItemReplaced&&e.onItemReplaced(s,r,parseInt(n))))),i.lastValue=o;}finally{i.suspend--;}}};r.subscribe(l),i.subscriptions.push({source:t,property:r,name:n,handler:l});}getBindingProperty(e){if("function"!=typeof e)return null;let t;return e(this.createProxy(this.model,((e,n)=>(t={obj:e,propName:n},!0)))),t&&t.obj?o(t.obj,t.propName):void 0}findParentModel(){let e=this.parent;for(;e;){if(e.model!=this.model)return e.model;e=e.parent;}}createProxy(t,i){if(!t||"object"!=typeof t||t[h])return t;const s={};return Array.isArray(t)&&(e$1(t)||n$1(t)),new Proxy(t,{get:(e,n)=>n===h||("@parent"===n?this.createProxy(this.findParentModel(),i):"symbol"==typeof n||"function"==typeof e[n]||Array.isArray(t)&&"length"===n?e[n]:(n in s||(i(t,n)?s[n]=this.createProxy(e[n],i):s[n]=e[n]),s[n]))})}cleanBindings(e){this._bindings.forEach((t=>this.unsubscribe(t,e))),this._modelBinders.forEach((t=>t.cleanBindings(e))),this._modelBinders=[],this._bindings=[];}updateModel(e){this.model=e,t$1(this._bindings,(e=>{const t=this.getBindingValue(e);e.lastValue!=t&&(e.action(t,e.lastValue,!0),e.lastValue=t);})),t$1(this._modelBinders,(t=>t.updateModel(e)));}model;parent}function c(e){return e&&"object"==typeof e&&"nodes"in e}const u={},m={};function p(e,t){return u[e]=t,t}class f extends d{_endElement;_startElement;_lastElement;_childCount=0;_updateCount=0;_updateNode=null;constructor(e,t,n){super(e),this.parent=n,this.element=t,t.namespaceURI&&"http://www.w3.org/1999/xhtml"!=t.namespaceURI&&(this.namespace=t.namespaceURI);}beginTemplate(e,t,n="after",i){const s=new f(e,this.element,this);return s._lastElement=this._lastElement,s.begin(t,n,i),"explicit"==this.inlineMode&&(s.isInline=this.isInline,s.inlineMode="inherit"),s}endTemplate(e){e.end(),e.element==this.element&&(this._lastElement=e._lastElement);}beginUpdate(){0==this._updateCount&&this.element.parentNode&&(this._updateNode=document.createTextNode(""),this.element.parentNode.replaceChild(this._updateNode,this.element)),this._updateCount++;}endUpdate(){this._updateCount--,0==this._updateCount&&this._updateNode&&(this._updateNode.parentNode.replaceChild(this.element,this._updateNode),this._updateNode=null);}begin(e,t,n){return this._startElement=n?document.createComment("begin-"+n):document.createTextNode(""),e?"after"==t?e.nextSibling?e.parentNode.insertBefore(this._startElement,e.nextSibling):e.parentNode.appendChild(this._startElement):"before"==t?e.parentNode.insertBefore(this._startElement,e):"inside"==t&&e.appendChild(this._startElement):this.appendChild(this._startElement),this._lastElement=this._startElement,this}end(){if(!this._endElement)return this._startElement.nodeType==Node.COMMENT_NODE?this._endElement=document.createComment(this._startElement.textContent.replace("begin-","end-")):this._endElement=document.createTextNode(""),this.appendChild(this._endElement),this}clear(e=!1){this._childCount=0,this._endElement||(console.warn("Missing end element: "+this.model),this.end());let t=this._endElement;for(;;){let n=!0;t!=this._startElement&&t!=this._endElement||e||(n=!1);const i=t.previousSibling;if(n&&n&&t.parentNode.removeChild(t),t==this._startElement)break;t=i;}return e?(this._endElement=null,this._startElement=null,this._lastElement=null):this._lastElement=this._startElement,this.cleanBindings(!0),this}appendChild(e){return this._lastElement&&this._lastElement.parentNode?this._lastElement.nextSibling?this._lastElement.parentNode.insertBefore(e,this._lastElement.nextSibling):this._lastElement.parentNode.appendChild(e):this.element.appendChild(e),this._lastElement=e,this}foreach(t,n){let i=[];const s=this.loadTemplate(n),r=document.createTextNode("");this.appendChild(r);const o={onClear:()=>{i.forEach((e=>e.clear(!0))),i=[];},onItemRemoved:(e,t,n)=>{"replace"!=n&&"clear"!=n&&(i[t].clear(!0),i.splice(t,1));},onItemSwap:(e,t)=>{},onItemReplaced:(e,t,n)=>{i[n].updateModel(e);},onReorder:()=>{const e=this.getBindValue(t);o.onClear();for(let t=0;t<e.length;t++)o.onItemAdded(e[t],t,"add");},onItemAdded:(e,t,n)=>{if("replace"==n)return;let o;t==i.length?(o=0==t?this.beginTemplate(e,r,"after",this.createMarker(e)):this.beginTemplate(e,i[t-1]._endElement,"after",this.createMarker(e)),i.push(o)):(o=this.beginTemplate(e,i[t]._startElement,"before",this.createMarker(e)),i.splice(t,0,o)),o.index=t,s(o),this.endTemplate(o);}};return this.bind(t,((t,n,i,s)=>{if(!s){if(this.beginUpdate(),i&&o.onClear(),e$1(n)&&n.unsubscribe(o),t){e$1(t)&&t.subscribe(o);for(let e=0;e<t.length;e++)o.onItemAdded(t[e],e,"add");}this.endUpdate();}})),this}if(e,t,n){const i=this.beginTemplate(this.model);return this.register(i),this.bind(e,((e,s,r,o)=>{o||(r&&i.clear(),e?i.template(t):n&&i.template(n));})),this.endTemplate(i),this}replaceContent(e){if(this.isInline)throw new Error("'replaceContent' not supported in inline elements");this.clear();for(const t of e)this.appendChild(t);}extractContent(){const e=[];for(const t of this.element.childNodes)t!=this._startElement&&t!=this._endElement&&e.push(t);return e}content(e,t=!1){const n=this.beginTemplate(void 0,void 0,void 0,this.createMarker(e));return n.isInline=t,n.inlineMode="explicit",this.bind(e,((e,t,i,s)=>{if(!s){if(this.beginUpdate(),!n.isInline&&c(e)&&e.nodes&&!0===e.isCacheEnabled)n.replaceContent(e.nodes);else {if(t&&e&&t.template==e.template)n.updateModel(e);else if(i&&n.clear(),e){const t=this.templateFor(e);if(!t)throw new Error("Template '"+e.template+"' not found.");n.updateModel(e),t(n);}c(e)&&!0===e.isCacheEnabled&&(e.nodes=this.extractContent());}this.endUpdate();}})),this.endTemplate(n),this}templateFor(e){if("string"==typeof e||"number"==typeof e)return this.loadTemplate("Text");if("object"==typeof e&&"template"in e)return this.loadTemplate(e.template);throw new Error("cannot determine template for model")}loadTemplate(e){if("string"==typeof e){const t=u[e];return t||console.error("Template ",e," not found."),t}return e}template(e,t){const n=this.loadTemplate(e);if(t){const e=this.beginTemplate(void 0,void 0,void 0,this.createMarker(t,"template"));this.bind(t,((t,i,s,r)=>{r||(e.updateModel(t),s||n(e));})),this.endTemplate(e);}else n(this);return this}exec(e){return e(this),this}beginChild(e,t){if(this.isInline&&this._childCount>0)throw new Error("In inline mode you must have a single root element for your template");const n=this.isInline&&e.toUpperCase()==this.element.tagName?this.element:this.createElement(e,t),i=new b(this.model,n,this);return n==this.element&&(i._lastElement=this._lastElement),this.register(i),this._childCount++,i}child(e,t,n){const i=new f(this.model,this.createElement(e,n),this);return this.register(i),"function"==typeof t?t(i):i.attribs(t),this.appendChild(i.element),this}set(e,t){return this.bind(t,(t=>{null!=t?t instanceof Promise?t.then((t=>this.element.setAttribute(e,t))):this.element.setAttribute(e,t):this.element.removeAttribute(e);})),this}on(e,t){return this.element.addEventListener(e,(e=>t(this.model,e))),this}class(e,t){if(t&&"string"==typeof e){const n=e?e.split(" "):[];this.bind(t,(e=>{e?n.forEach((e=>this.element.classList.add(e))):n.forEach((e=>this.element.classList.remove(e)));}));}else this.bind(e,((e,t)=>{t&&t.split(" ").forEach((e=>this.element.classList.remove(e))),e&&e.split(" ").forEach((e=>this.element.classList.add(e)));}));return this}visible(e){return this.bind(e,((e,t,n,i)=>{i||(e?(this.element.classList.add("visible"),this.element.classList.remove("hidden")):(this.element.classList.add("hidden"),this.element.classList.remove("visible")));})),this}text(e){const t=document.createTextNode("");return this.appendChild(t),this.bind(e,(e=>t.textContent=e)),this}html(e){return this.bind(e,(e=>this.element.innerHTML=e)),this}focus(e){const t=this.getBindingProperty(e);return t&&(this.element.addEventListener("focus",(e=>t.set(!0))),this.element.addEventListener("focusout",(e=>t.set(!1)))),this.bind(e,(e=>{e&&document.activeElement!=this.element&&this.element.focus();})),this}value(e){const t=this.element,n=this.getBindingProperty(e);return n&&("INPUT"==t.tagName||"TEXTAREA"==t.tagName?"checkbox"==t.type||"radio"==t.type?t.addEventListener("change",(e=>{n.set(t.checked);})):(t.addEventListener("keyup",(e=>{n.set(t.value);})),t.addEventListener("change",(e=>{n.set(t.value);}))):"SELECT"==t.tagName&&t.addEventListener("change",(e=>{n.set(t.value);}))),"INPUT"!=t.tagName&&"TEXTAREA"!=t.tagName&&"SELECT"!=t.tagName||("checkbox"==t.type||"radio"==t.type?this.bind(e,(e=>t.checked=e)):this.bind(e,(e=>t.value=e||null))),this}style(e,t){return this.bind(t,(t=>this.element.style[e]=t)),this}behavoir(e){return "string"==typeof e?m[e]().attach(this.element,this.model):e.attach(this.element,this.model),this}styles(e){for(const t in e)this.bind(e[t],(e=>this.element.style[t]=e));return this}attribs(e){for(const t in e)this.set(t,e[t]);return this}debugger(){return this}createElement(e,t){return t||(t=this.namespace),t?document.createElementNS(t,e):document.createElement(e)}createMarker(e,t=""){}namespace=null;element=null;parent=null;isInline=!1;inlineMode="never";index=0}class b extends f{constructor(e,t,n){super(e,t,n);}endChild(){return this.parent.element!=this.element?this.parent.appendChild(this.element):this._lastElement&&(this.parent._lastElement=this._lastElement),this.parent}}function g(e,t,n){e.innerHTML="";const i=new f(n,e);i.begin(),i.loadTemplate(t)(i),i.end();}window.__defineTemplate=p;

function e(e,n){return n}function n(n){return e(n.name,(e=>i({builder:e},n.children)))}function t(e){return e&&"object"==typeof e&&"props"in e&&"type"in e}function i(e,n){if(null!=n)if(Array.isArray(n))for(const t of n)i(e,t);else if("string"==typeof n)e.builder.text(n);else if(t(n))if("string"==typeof n.type){const t=e.builder.beginChild(n.type);for(const e in n.props){if("children"==e)continue;const i=n.props[e];if("style"==e)i&&t.styles(i);else if("value"==e)t.value(i);else if("text"==e)t.text(i);else if("visible"==e)t.visible(i);else if("html"==e)t.html(i);else if("focus"==e)t.focus(i);else if("class"==e)t.class(i);else if("behavoir"==e){const e=Array.isArray(i)?i:[i];for(const n of e)t.behavoir(n);}else e.startsWith("on-")?t.on(e.substring(3),i):t.set(e,i);}i({builder:t},n.props.children),t.endChild();}else if(n.type.toString().startsWith("class ")){const t=new n.type(n.props);e.builder.content(t);}else {i(e,n.type({...n.props,context:e}));}else "function"==typeof n&&e.builder.text(n);}window.__defineTemplate=e,window.__createElement=function(e,t,...i){return "function"==typeof e&&e==n?e({...t,children:i}):{type:e,props:{...t,children:i}}};

async function runAsync() {
    const rootModel = {
        items: [],
        msg: "",
        innerObj: {
            name: "Inner"
        },
        logo: "/logo.png",
        change() {
            this.msg = "Nuovo messaggio" + new Date().getTime();
            if (this.items.length > 0)
                this.items[0].name = "Item change" + new Date().getTime();
            this.innerObj.name = "Inner change" + new Date().getTime();
        },
        replace() {
            if (this.items.length > 0)
                this.items[0] = {
                    name: "Pippo"
                };
            this.innerObj = {
                name: "Replace inner"
            };
        },
        add() {
            this.items.push({ name: "Luca" }, { name: "Mario" });
        },
        addMany() {
            const newItems = [];
            for (let i = 0; i < 10000; i++)
                newItems.push({ name: "Item " + i });
            this.items.push(...newItems);
        },
        newImage() {
            this.logo = "https://www.google.com/images/branding/googlelogo/1x/googlelogo_color_272x92dp.png";
        }
    };
    setInterval(() => {
        rootModel.msg = "Time is: " + new Date();
    }, 1000);
    const t = __defineTemplate("xxx", t => { t
    .beginChild("div").text(m => m.innerObj.name)
        .beginChild("button").on("click", m => m.addMany()).text("Add").endChild()
    .endChild()
    .foreach(m => m.items, t1 => t1
        .beginChild("div").text(m => m.name).endChild()
    );
});
    __defineTemplate("yyy", t => {});
    g(document.body, t, rootModel);
}
window.addEventListener("load", runAsync);
//# sourceMappingURL=app.js.map
